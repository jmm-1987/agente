{% extends "base.html" %}

{% block title %}Tareas - Agenda Telegram{% endblock %}

{% block content %}
<div class="filters">
    <form method="GET" action="{{ url_for('tasks') }}" id="filterForm" class="filter-form">
        <!-- Logo con contenedor redondo a la izquierda -->
        <div class="logo-container">
            <img src="{{ url_for('static', filename='logoagenda.png') }}" alt="Logo" class="logo-img">
        </div>
        <!-- MenÃº circular tipo dock -->
        <div class="dock-container">
            <!-- Vista -->
            <div class="dock-item" data-filter="view_mode">
                <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Vista">
                    <span class="dock-icon">ğŸ“‹</span>
                    <span class="dock-tooltip">Vista</span>
                </button>
                <div class="dock-menu">
                    <div class="dock-menu-content">
                        <label class="dock-option">
                            <input type="radio" name="view_mode" value="list" {% if view_mode != 'calendar' %}checked{% endif %} onchange="changeView('list')">
                            <span>ğŸ“‹ Lista</span>
                        </label>
                        <label class="dock-option">
                            <input type="radio" name="view_mode" value="calendar" {% if view_mode == 'calendar' %}checked{% endif %} onchange="changeView('calendar')">
                            <span>ğŸ“… Semana</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Estado -->
            <div class="dock-item" data-filter="status">
                <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Estado">
                    <span class="dock-icon">ğŸ“Š</span>
                    <span class="dock-tooltip">Estado</span>
                </button>
                <div class="dock-menu">
                    <div class="dock-menu-content">
                        <label class="dock-option">
                            <input type="radio" name="status" value="all" {% if current_status == 'all' %}checked{% endif %}>
                            <span>ğŸ“Š Todos</span>
                        </label>
                        <label class="dock-option">
                            <input type="radio" name="status" value="open" {% if current_status == 'open' or current_status == '' %}checked{% endif %}>
                            <span>ğŸŸ¦ Abiertas</span>
                        </label>
                        <label class="dock-option">
                            <input type="radio" name="status" value="completed" {% if current_status == 'completed' %}checked{% endif %}>
                            <span>âœ… Completadas</span>
                        </label>
                        <label class="dock-option">
                            <input type="radio" name="status" value="cancelled" {% if current_status == 'cancelled' %}checked{% endif %}>
                            <span>âŒ Canceladas</span>
                        </label>
                    </div>
                </div>
</div>

            <!-- Prioridad -->
            <div class="dock-item" data-filter="priority">
                <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Prioridad">
                    <span class="dock-icon">âš¡</span>
                    <span class="dock-tooltip">Prioridad</span>
                </button>
                <div class="dock-menu">
                    <div class="dock-menu-content">
                        <label class="dock-option">
                            <input type="radio" name="priority" value="all" {% if current_priority == 'all' %}checked{% endif %}>
                            <span>âš¡ Todas</span>
                        </label>
                        <label class="dock-option">
                            <input type="radio" name="priority" value="urgent" {% if current_priority == 'urgent' %}checked{% endif %}>
                            <span>ğŸ”´ Urgente</span>
                        </label>
                        <label class="dock-option">
                            <input type="radio" name="priority" value="high" {% if current_priority == 'high' %}checked{% endif %}>
                            <span>ğŸŸ  Alta</span>
                        </label>
                        <label class="dock-option">
                            <input type="radio" name="priority" value="normal" {% if current_priority == 'normal' %}checked{% endif %}>
                            <span>ğŸŸ¡ Normal</span>
                        </label>
                        <label class="dock-option">
                            <input type="radio" name="priority" value="low" {% if current_priority == 'low' %}checked{% endif %}>
                            <span>ğŸŸ¢ Baja</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Usuario -->
            <div class="dock-item" data-filter="user_id">
                <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Usuario">
                    <span class="dock-icon">ğŸ‘¤</span>
                    <span class="dock-tooltip">Usuario</span>
                </button>
                <div class="dock-menu">
                    <div class="dock-menu-content">
                        <label class="dock-option">
                            <input type="radio" name="user_id" value="" {% if not current_user_id %}checked{% endif %}>
                            <span>ğŸ‘¤ Todos</span>
                        </label>
                        {% for uid, uname in users.items() %}
                        <label class="dock-option">
                            <input type="radio" name="user_id" value="{{ uid }}" {% if current_user_id == uid %}checked{% endif %}>
                            <span>{{ uname }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Fecha -->
            <div class="dock-item" data-filter="task_date">
                <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Fecha">
                    <span class="dock-icon">ğŸ“…</span>
                    <span class="dock-tooltip">Fecha</span>
                </button>
                <div class="dock-menu">
                    <div class="dock-menu-content">
                        <input type="date" name="task_date" value="{{ current_task_date }}" class="dock-date-input" placeholder="Fecha">
                    </div>
                </div>
                </div>
                
            <!-- CategorÃ­a -->
            <div class="dock-item" data-filter="category">
                <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="CategorÃ­a">
                    <span class="dock-icon">ğŸ“‚</span>
                    <span class="dock-tooltip">CategorÃ­a</span>
                </button>
                <div class="dock-menu">
                    <div class="dock-menu-content">
                        <label class="dock-option">
                            <input type="radio" name="category" value="all" {% if current_category == 'all' or not current_category %}checked{% endif %}>
                            <span>ğŸ“‚ Todas</span>
                        </label>
                        {% for cat in categories %}
                        <label class="dock-option">
                            <input type="radio" name="category" value="{{ cat.name }}" {% if current_category == cat.name %}checked{% endif %}>
                            <span style="color: {{ cat.color }};">{{ cat.icon }} {{ cat.display_name or cat.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Editar CategorÃ­as -->
            <div class="dock-item dock-action">
                <a href="{{ url_for('categories') }}" class="dock-button dock-button-settings" title="Editar categorÃ­as">
                    <span class="dock-icon">âš™ï¸</span>
                    <span class="dock-tooltip">Editar categorÃ­as</span>
                </a>
            </div>
                
            <!-- BÃºsqueda -->
            <div class="dock-item" data-filter="search">
                <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Buscar">
                    <span class="dock-icon">ğŸ”</span>
                    <span class="dock-tooltip">Buscar</span>
                </button>
                <div class="dock-menu">
                    <div class="dock-menu-content">
                        <input type="text" name="search" value="{{ current_search or '' }}" class="dock-search-input" placeholder="Buscar...">
                    </div>
                </div>
            </div>
            
            <!-- Filtrar -->
            <div class="dock-item dock-action">
                <button type="submit" class="dock-button dock-button-primary" title="Filtrar">
                    <span class="dock-icon">âœ“</span>
                    <span class="dock-tooltip">Filtrar</span>
                    </button>
            </div>
            
            <!-- Limpiar -->
            <div class="dock-item dock-action">
                <a href="{{ url_for('tasks') }}" class="dock-button dock-button-secondary" title="Limpiar">
                    <span class="dock-icon">ğŸ”„</span>
                    <span class="dock-tooltip">Limpiar</span>
                </a>
            </div>
            
            <!-- Logout -->
            <div class="dock-item dock-action">
                <a href="{{ url_for('logout') }}" class="dock-button dock-button-danger" title="Cerrar sesiÃ³n">
                    <span class="dock-icon">âœ•</span>
                    <span class="dock-tooltip">Cerrar sesiÃ³n</span>
                </a>
            </div>
        </div>
    </form>
</div>

<div class="tasks-list">
    <!-- Slider para tareas sin fecha (siempre visible) -->
    {% if tasks_without_date %}
    <div class="no-date-section" style="margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h3 style="color: white; margin: 0; font-size: 1.2rem; font-weight: 600;">ğŸ“‹ Tareas sin fecha</h3>
            <button type="button" class="toggle-section-btn" onclick="toggleNoDateSection()" id="toggleNoDateBtn" title="Mostrar/Ocultar tareas sin fecha">
                <svg id="toggleNoDateIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="transition: transform 0.3s ease;">
                    <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </button>
        </div>
        <div class="tasks-slider" id="noDateSlider" style="display: block;">
            <div class="slider-container">
                <div class="slider-track">
                    {% for task in tasks_without_date %}
                    <div class="task-card-slide">
                        {% include 'task_card.html' %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <button class="slider-btn slider-btn-prev" onclick="scrollSlider(this, 'prev')">â€¹</button>
            <button class="slider-btn slider-btn-next" onclick="scrollSlider(this, 'next')">â€º</button>
        </div>
    </div>
    <div id="noDateDivider" style="border-bottom: 2px solid rgba(255, 255, 255, 0.2); margin: 2rem 0; width: 100%;"></div>
    {% endif %}
    
    {% if view_mode == 'calendar' %}
    <!-- Vista de calendario semanal -->
    <div class="calendar-view">
        <div class="weekly-calendar">
            {% set week_days = [
                ('Lunes', 'Monday'),
                ('Martes', 'Tuesday'),
                ('MiÃ©rcoles', 'Wednesday'),
                ('Jueves', 'Thursday'),
                ('Viernes', 'Friday'),
                ('SÃ¡bado', 'Saturday'),
                ('Domingo', 'Sunday')
            ] %}
            {% for day_name, day_key in week_days %}
            <div class="calendar-day">
                <div class="calendar-day-header">
                    <h4>{{ day_name }}</h4>
                </div>
                <div class="calendar-day-tasks">
                    {% for task in tasks_with_date %}
                        {% if task.task_date %}
                            {% set task_weekday = task.task_date|date_weekday %}
                            {% if task_weekday == day_key %}
                                <div class="calendar-task-item">
                                    <div class="calendar-task-title">{{ task.title }}</div>
                                    <div class="calendar-task-meta">
                                        <span class="priority-badge priority-{{ task.priority }}">{{ task.priority }}</span>
                                        {% if task.category %}
                                        {% set category_names = {
                                            'administracion': 'ğŸ“‹',
                                            'averias': 'ğŸ”§',
                                            'clientes': 'ğŸ‘¤',
                                            'servicios': 'âš™ï¸'
                                        } %}
                                        <span class="category-badge category-{{ task.category }}">{{ category_names.get(task.category, '') }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
            </div>
        </div>
        {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Vista de lista -->
    <!-- Grid para tareas con fecha -->
    {% if tasks_with_date %}
    <div class="with-date-section">
        <h3 style="color: white; margin-bottom: 1rem; font-size: 1.3rem; font-weight: 600;">ğŸ“… Tareas con fecha</h3>
        <div class="tasks-grid">
            {% for task in tasks_with_date %}
                {% include 'task_card.html' %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if not tasks_with_date and not tasks_without_date %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <h3>No hay tareas</h3>
        <p>No se encontraron tareas con los filtros seleccionados.</p>
    </div>
    {% endif %}
    {% endif %}
</div>

<!-- Modal para imÃ¡genes -->
<div id="imagesModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
        <span class="close" onclick="closeImagesModal()">&times;</span>
        <h3 style="margin-top: 0;">ğŸ“· ImÃ¡genes adjuntas</h3>
        <div id="imagesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; max-height: 70vh; overflow-y: auto;">
            <!-- Las imÃ¡genes se cargarÃ¡n aquÃ­ -->
        </div>
    </div>
</div>

<!-- Modal para editar tarea -->
<div id="editTaskModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <span class="close" onclick="closeEditTaskModal()">&times;</span>
        <h3 style="margin-top: 0;">âœï¸ Editar Tarea</h3>
        
        <form id="editTaskForm" onsubmit="saveTaskEdit(event)">
            <input type="hidden" id="editTaskId" name="task_id">
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label for="editTitle" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">TÃ­tulo:</label>
                <input type="text" id="editTitle" name="title" required style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label for="editDescription" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">DescripciÃ³n:</label>
                <textarea id="editDescription" name="description" rows="4" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label for="editStatus" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Estado:</label>
                    <select id="editStatus" name="status" required style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                        <option value="open">ğŸŸ¦ Abierta</option>
                        <option value="completed">âœ… Completada</option>
                        <option value="cancelled">âŒ Cancelada</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editPriority" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Prioridad:</label>
                    <select id="editPriority" name="priority" required style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                        <option value="low">ğŸŸ¢ Baja</option>
                        <option value="normal">ğŸŸ¡ Normal</option>
                        <option value="high">ğŸŸ  Alta</option>
                        <option value="urgent">ğŸ”´ Urgente</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label for="editTaskDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Fecha:</label>
                    <input type="date" id="editTaskDate" name="task_date" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                </div>
                
                <div class="form-group">
                    <label for="editCategory" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">CategorÃ­a:</label>
                    <select id="editCategory" name="category" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                        <option value="">Sin categorÃ­a</option>
                        {% for cat in categories %}
                        <option value="{{ cat.name }}">{{ cat.icon }} {{ cat.display_name or cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label for="editClient" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Cliente:</label>
                <select id="editClient" name="client_id" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                    <option value="">Sin cliente</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}">{{ client.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label for="editAmpliacion" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">AmpliaciÃ³n:</label>
                <textarea id="editAmpliacion" name="ampliacion" rows="3" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeEditTaskModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="saveTaskButton">ğŸ’¾ Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para soluciÃ³n -->
<div id="solutionModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeSolutionModal()">&times;</span>
        <h3 style="margin-top: 0;">ğŸ’¡ AÃ±adir/Editar SoluciÃ³n</h3>
        
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #1e3a5f;">
            <strong style="color: #1e3a5f; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">ğŸ“‹ Tarea:</strong>
            <p id="modalTaskTitle" style="margin: 0; color: #495057; font-size: 1rem; line-height: 1.5;"></p>
        </div>
        
        <form method="POST" action="" id="solutionForm">
            <div class="form-group">
                <label for="solution">SoluciÃ³n/ResoluciÃ³n:</label>
                <textarea id="solution" name="solution" rows="6" style="width: 100%; padding: 0.5rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeSolutionModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
function openSolutionModalFromButton(button) {
    const taskId = button.getAttribute('data-task-id');
    const taskTitle = button.getAttribute('data-task-title');
    const solutionJson = button.getAttribute('data-solution');
    let currentSolution = '';
    
    if (solutionJson) {
        try {
            currentSolution = JSON.parse(solutionJson);
        } catch (e) {
            currentSolution = solutionJson;
        }
    }
    
    openSolutionModal(taskId, taskTitle, currentSolution);
}

function openSolutionModal(taskId, taskTitle, currentSolution) {
    const modal = document.getElementById('solutionModal');
    const form = document.getElementById('solutionForm');
    const textarea = document.getElementById('solution');
    const titleElement = document.getElementById('modalTaskTitle');
    
    form.action = '/admin/tasks/' + taskId + '/solution';
    textarea.value = currentSolution || '';
    titleElement.textContent = taskTitle || 'Sin tÃ­tulo';
    modal.style.display = 'flex';
}

function closeSolutionModal() {
    document.getElementById('solutionModal').style.display = 'none';
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const modal = document.getElementById('solutionModal');
    if (event.target == modal) {
        closeSolutionModal();
    }
    
    // Cerrar dropdowns de acciones al hacer clic fuera
    if (!event.target.closest('.dropdown-actions')) {
        document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
}

// Funciones para el slider de tareas sin fecha
function scrollSlider(button, direction) {
    const slider = button.closest('.tasks-slider');
    if (!slider) return;
    
    const sliderTrack = slider.querySelector('.slider-track');
    if (!sliderTrack) return;
    
    const firstSlide = sliderTrack.querySelector('.task-card-slide');
    if (!firstSlide) return;
    
    const slideWidth = firstSlide.offsetWidth + 16; // 16px de gap (1rem)
    const scrollAmount = direction === 'next' ? slideWidth : -slideWidth;
    
    sliderTrack.scrollBy({
        left: scrollAmount,
        behavior: 'smooth'
    });
}

// Funciones de acciones eliminadas - ahora los botones estÃ¡n directamente visibles

function changeView(viewMode) {
    const url = new URL(window.location.href);
    url.searchParams.set('view_mode', viewMode);
    window.location.href = url.toString();
}

function toggleNoDateSection() {
    const slider = document.getElementById('noDateSlider');
    const icon = document.getElementById('toggleNoDateIcon');
    const divider = document.getElementById('noDateDivider');
    
    if (slider.style.display === 'none') {
        slider.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
        if (divider) divider.style.display = 'block';
    } else {
        slider.style.display = 'none';
        icon.style.transform = 'rotate(180deg)';
        if (divider) divider.style.display = 'none';
    }
}

function openTaskImages(taskId, imagesJson) {
    const modal = document.getElementById('imagesModal');
    const container = document.getElementById('imagesContainer');
    
    // Parsear JSON si es string
    let images;
    if (typeof imagesJson === 'string') {
        try {
            images = JSON.parse(imagesJson);
        } catch (e) {
            console.error('Error parsing images JSON:', e);
            images = [];
        }
    } else {
        images = imagesJson;
    }
    
    // Limpiar contenedor
    container.innerHTML = '';
    
    if (!images || images.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No hay imÃ¡genes disponibles.</p>';
        modal.style.display = 'flex';
        return;
    }
    
    // Crear elementos de imagen
    images.forEach(image => {
        const imageDiv = document.createElement('div');
        imageDiv.style.cssText = 'position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s ease;';
        imageDiv.onmouseenter = function() {
            this.style.transform = 'scale(1.05)';
        };
        imageDiv.onmouseleave = function() {
            this.style.transform = 'scale(1)';
        };
        
        const img = document.createElement('img');
        img.src = `/admin/tasks/${taskId}/images/${image.id}`;
        img.style.cssText = 'width: 100%; height: 200px; object-fit: cover; display: block;';
        img.onerror = function() {
            this.style.display = 'none';
            imageDiv.innerHTML = '<div style="width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; color: #6c757d;">Imagen no disponible</div>';
        };
        img.onclick = function(e) {
            e.stopPropagation();
            window.open(img.src, '_blank');
        };
        
        imageDiv.appendChild(img);
        container.appendChild(imageDiv);
    });
    
    modal.style.display = 'flex';
}

function closeImagesModal() {
    document.getElementById('imagesModal').style.display = 'none';
}

// Funciones para el menÃº dock circular
function toggleDockMenu(button) {
    const dockItem = button.closest('.dock-item');
    const isActive = dockItem.classList.contains('active');
    
    // Cerrar todos los menÃºs
    document.querySelectorAll('.dock-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Abrir el menÃº seleccionado si no estaba activo
    if (!isActive) {
        // Calcular posiciÃ³n del botÃ³n
        const buttonRect = button.getBoundingClientRect();
        const menu = dockItem.querySelector('.dock-menu');
        
        if (menu) {
            // Calcular el centro exacto del botÃ³n relativo al viewport
            const buttonCenterX = buttonRect.left + (buttonRect.width / 2);
            const buttonBottomY = buttonRect.bottom;
            
            // Hacer el menÃº visible temporalmente para medir su ancho
            menu.style.visibility = 'hidden';
            menu.style.opacity = '0';
            menu.style.position = 'fixed';
            menu.style.display = 'block';
            menu.style.transform = 'translateX(-50%) scale(1)';
            menu.style.left = buttonCenterX + 'px';
            menu.style.top = (buttonBottomY + 10) + 'px';
            
            // Forzar reflow para que el navegador calcule el tamaÃ±o
            void menu.offsetWidth;
            
            // Establecer posiciÃ³n final del menÃº
            // Usamos translateX(-50%) para centrar desde el punto del botÃ³n
            menu.style.position = 'fixed';
            menu.style.top = (buttonBottomY + 10) + 'px';
            menu.style.left = buttonCenterX + 'px';
            menu.style.transform = 'translateX(-50%) scale(1)';
            menu.style.margin = '0';
            menu.style.padding = '0';
            menu.style.zIndex = '10000';
            menu.style.visibility = ''; // Restaurar visibilidad
            menu.style.opacity = ''; // Restaurar opacidad
        }
        
        dockItem.classList.add('active');
    }
}

// Auto-enviar formulario al cambiar opciones
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filterForm');
    const radioButtons = form.querySelectorAll('input[type="radio"]');
    const dateInput = form.querySelector('input[type="date"]');
    const searchInput = form.querySelector('input[name="search"]');
    
    // Auto-enviar al cambiar radios (con pequeÃ±o delay para UX)
        radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            // Cerrar el menÃº
            this.closest('.dock-item')?.classList.remove('active');
            
            // Restaurar scroll
            const scrollY = document.body.style.top;
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
            
            // Enviar formulario despuÃ©s de un pequeÃ±o delay
            setTimeout(() => {
                form.submit();
            }, 300);
        });
    });
    
    // Auto-enviar al cambiar fecha (con delay para que el usuario pueda seleccionar)
    if (dateInput) {
        let dateTimeout;
        dateInput.addEventListener('change', function() {
            clearTimeout(dateTimeout);
            this.closest('.dock-item')?.classList.remove('active');
            
            // Restaurar scroll
            const scrollY = document.body.style.top;
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
            
            dateTimeout = setTimeout(() => {
                form.submit();
            }, 500);
        });
    }
    
    // Auto-enviar al escribir en bÃºsqueda (con debounce)
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.length === 0 || this.value.length >= 3) {
                    this.closest('.dock-item')?.classList.remove('active');
                    
                    // Restaurar scroll
                    const scrollY = document.body.style.top;
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.top = '';
                    document.body.style.width = '';
                    if (scrollY) {
                        window.scrollTo(0, parseInt(scrollY || '0') * -1);
                    }
                    
                    form.submit();
                }
            }, 800);
        });
    }
});

// Cerrar menÃºs del dock al hacer clic fuera
document.addEventListener('click', function(event) {
    if (!event.target.closest('.dock-item')) {
        document.querySelectorAll('.dock-item').forEach(item => {
            item.classList.remove('active');
        });
        // Restaurar scroll cuando se cierra el menÃº
        const scrollY = document.body.style.top;
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        if (scrollY) {
            window.scrollTo(0, parseInt(scrollY || '0') * -1);
        }
    }
});

// Cerrar modal de imÃ¡genes al hacer clic fuera
window.onclick = function(event) {
    const solutionModal = document.getElementById('solutionModal');
    const imagesModal = document.getElementById('imagesModal');
    
    if (event.target == solutionModal) {
        closeSolutionModal();
    }
    
    if (event.target == imagesModal) {
        closeImagesModal();
    }
    
    // Cerrar dropdowns de acciones al hacer clic fuera
    if (!event.target.closest('.dropdown-actions')) {
        document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
}

// Funciones para el modal de ediciÃ³n de tarea
async function openEditTaskModal(taskId) {
    const modal = document.getElementById('editTaskModal');
    const form = document.getElementById('editTaskForm');
    const saveButton = document.getElementById('saveTaskButton');
    
    // Mostrar modal
    modal.style.display = 'block';
    
    // Deshabilitar botÃ³n mientras carga
    saveButton.disabled = true;
    saveButton.textContent = 'â³ Cargando...';
    
    try {
        // Obtener datos de la tarea
        const response = await fetch(`/admin/tasks/${taskId}/edit`);
        const task = await response.json();
        
        if (response.ok && task) {
            // Rellenar formulario
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTitle').value = task.title || '';
            document.getElementById('editDescription').value = task.description || '';
            document.getElementById('editStatus').value = task.status || 'open';
            document.getElementById('editPriority').value = task.priority || 'normal';
            document.getElementById('editTaskDate').value = task.task_date ? task.task_date.split('T')[0] : '';
            document.getElementById('editCategory').value = task.category || '';
            document.getElementById('editClient').value = task.client_id || '';
            document.getElementById('editAmpliacion').value = task.ampliacion || '';
            
            saveButton.disabled = false;
            saveButton.textContent = 'ğŸ’¾ Guardar Cambios';
        } else {
            throw new Error(task.error || 'Error al cargar la tarea');
        }
    } catch (error) {
        alert('Error al cargar la tarea: ' + error.message);
        closeEditTaskModal();
    }
}

function closeEditTaskModal() {
    const modal = document.getElementById('editTaskModal');
    modal.style.display = 'none';
    document.getElementById('editTaskForm').reset();
}

async function saveTaskEdit(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const taskId = formData.get('task_id');
    const saveButton = document.getElementById('saveTaskButton');
    
    // Convertir FormData a objeto
    const data = {
        title: formData.get('title'),
        description: formData.get('description') || null,
        status: formData.get('status'),
        priority: formData.get('priority'),
        task_date: formData.get('task_date') || null,
        category: formData.get('category') || null,
        client_id: formData.get('client_id') ? parseInt(formData.get('client_id')) : null,
        ampliacion: formData.get('ampliacion') || null
    };
    
    // Limpiar valores vacÃ­os
    Object.keys(data).forEach(key => {
        if (data[key] === '' || data[key] === null) {
            delete data[key];
        }
    });
    
    saveButton.disabled = true;
    saveButton.textContent = 'â³ Guardando...';
    
    try {
        const response = await fetch(`/admin/tasks/${taskId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Recargar la pÃ¡gina para ver los cambios
            window.location.reload();
        } else {
            throw new Error(result.error || 'Error al guardar');
        }
    } catch (error) {
        alert('Error al guardar: ' + error.message);
        saveButton.disabled = false;
        saveButton.textContent = 'ğŸ’¾ Guardar Cambios';
    }
}

// Cerrar modal al hacer clic fuera
const originalOnClick = window.onclick;
window.onclick = function(event) {
    if (originalOnClick) originalOnClick(event);
    const editModal = document.getElementById('editTaskModal');
    if (event.target == editModal) {
        closeEditTaskModal();
    }
}
</script>
{% endblock %}

